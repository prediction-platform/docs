# Como integrar o YC365 Dapp

## Vis√£o geral

Este guia explica como a plataforma do comerciante se conecta ao YC365 Dapp. A comunica√ß√£o suporta dois modos: sem transfer√™ncia (v1) e com transfer√™ncia (v2).

- **Modo sem transfer√™ncia**
  
  O usu√°rio entra no Dapp a partir da plataforma do comerciante sem precisar recarregar antecipadamente. Quando faz um pedido, os fundos s√£o debitados diretamente da conta da plataforma. O backend do Dapp mant√©m comunica√ß√£o em tempo real com o backend do comerciante.

  ![img.png](../img/yc365/img_11.png)

- **Modo com transfer√™ncia**

  Ao acessar o Dapp, o usu√°rio transfere parte de seus ativos da conta da plataforma para a conta do Dapp. O backend do Dapp permanece relativamente independente e n√£o requer comunica√ß√£o em tempo real com a plataforma.

  ![img.png](../img/yc365/img_10.png)

## üéØ Funcionalidades principais

1. **Obter c√≥digo de convite para registro**: fornecido offline por um representante comercial da YC365. Um c√≥digo equivale a uma conta de comerciante.
2. **Registro do comerciante**: este endpoint precisa ser liberado manualmente. O comerciante (ou o time YC365) envia os par√¢metros necess√°rios e, ap√≥s o registro, recebe `app_id`, `api_key` e `wallet_address`, que devem ser guardados com seguran√ßa.
   - Antes de registrar, √© preciso preparar as integra√ß√µes e escolher entre os modos v1 ou v2, pois cada modo exige APIs diferentes.
   - Armazene `app_id` e `api_key` no backend do comerciante; `api_key` √© usada para assinar/encriptar a comunica√ß√£o com o backend do Dapp.
   - `wallet_address` √© o endere√ßo do comerciante no Dapp e deve ser abastecido com USDT na BSC.
3. **Obter URL de acesso ao Dapp**: quando o usu√°rio clica em um link ou √≠cone na plataforma, o backend do comerciante chama esta API com os par√¢metros necess√°rios para receber o endere√ßo do Dapp.
4. **Detalhes de pedidos**: o comerciante consegue visualizar as transa√ß√µes dentro do Dapp, facilitando a concilia√ß√£o.
5. **Relat√≥rios para o comerciante**: disponibiliza dados di√°rios, semanais e mensais.
6. **Envio di√°rio de resumo**: o backend do Dapp envia o resumo do dia anterior √†s 00:00 UTC.

Formato de dados:
```json
{
  "event_type": "merchant_overview", // Tipo de evento: resumo di√°rio
  "data": {
     "app_id":"string",            // ID do comerciante
     "balance":0.000000,           // Saldo dispon√≠vel em USDT
     "frozen":0.000000,            // Saldo congelado em USDT
     "period_date":"string",       // Primeiro dia do per√≠odo, ex.: 2025-08-01
     "users":0,                    // Total de usu√°rios do comerciante no Dapp
     "total_deposit":0.000000,     // Valor total depositado (0 no modo v1)
     "total_deposit_count":0,      // N√∫mero de dep√≥sitos (0 no modo v1)
     "total_withdraw":0.000000,    // Valor total sacado (0 no modo v1)
     "total_withdraw_count":0,     // N√∫mero de saques (0 no modo v1)
     "total_buy_volume":0.000000,  // Volume total de compras
     "total_sell_volume":0.000000, // Volume total de vendas
     "currency":"string"           // Moeda: USDT
  },
  "signature": "xxxxxxxx"
}
```

## üõ°Ô∏è C√≥digos de status

| C√≥digo | Significado | Descri√ß√£o |
| ------ | ---- | ---- |
| 0 | OK | Requisi√ß√£o conclu√≠da |
| 1 | Canceled | Requisi√ß√£o cancelada |
| 2 | Unknown | Erro desconhecido |
| 3 | InvalidArgument | Par√¢metro inv√°lido |
| 7 | PermissionDenied | Falha na autentica√ß√£o por assinatura |
| 8 | ResourceExhausted | Limite de requisi√ß√µes excedido |
| 13 | Internal | Erro interno do servi√ßo |

## üí° APIs dispon√≠veis

O YC365 Dapp disponibiliza os seguintes endpoints para integra√ß√£o do comerciante.

### 1. Obter c√≥digo de convite

**GET** `/account/v1/app/invitecode`

O c√≥digo √© retirado offline. O cabe√ßalho deve conter `Authorization`.

**Resposta**
```json
{
   "code": 0,
   "message": "string",
   "data": "string"    // C√≥digo de convite
}
```

### 2. Criar comerciante

**POST** `/account/v1/app/create`

Antes de criar o comerciante, contate o representante YC365 para obter o c√≥digo de convite.

**Corpo da requisi√ß√£o**
```json
{
   "app_name": "string",         // Nome do comerciante
   "app_desc": "string",         // Descri√ß√£o
   "api_version": "string",      // v1 = sem transfer√™ncia, v2 = com transfer√™ncia
   "signature_method": "string", // Atualmente apenas hmac-sha256
   "assets_api": "string",
   "create_order_api": "string",
   "trade_order_api": "string",
   "cancel_order_api": "string",
   "settlement_api": "string",
   "webhook_api": "string",
   "invite_code": "string"       // C√≥digo de convite
}
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {
        "app_id": "string",        // ID do comerciante
        "api_key": "string",       // Chave API
        "wallet_address": "string" // Endere√ßo de carteira
    }
}
```

### 3. Obter URL de acesso ao Dapp

**POST** `/account/v1/app/access`

Usado para gerar o link de acesso para o usu√°rio. `Authorization` deve ser Base64 de `app_id:signature` (detalhes na se√ß√£o de assinatura).

**Corpo da requisi√ß√£o**
```json
{
   "user_id": "string",   // ID √∫nico do usu√°rio na plataforma
   "user_name": "string", // Apelido do usu√°rio
   "lang": "string",      // Idioma: en ou zh
   "email": "string",     // E-mail opcional
   "phone": "string",     // Telefone opcional, ex.: +55 11999999999
   "avatar": "string",    // URL do avatar
   "timestamp": 0,        // Timestamp em milissegundos
   "signature": "string"  // Assinatura da carga √∫til
}
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {
        "url": "string" // URL do Dapp
    }
}
```

### 4. Sincronizar ativos (apenas v1)

**POST** `/account/v1/app/account/assets`

Sincroniza os saldos do usu√°rio no modo sem transfer√™ncia.

**Corpo da requisi√ß√£o**
```json
{
   "user_id": "string",
   "assets": [
     {
       "asset": "string",   // Tipo de ativo (USDT)
       "balance": 0.000000, // Saldo dispon√≠vel
       "frozen": 0.000000   // Saldo congelado
     }
   ],
   "timestamp": 0,
   "signature": "string"
}
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {}
}
```

### 5. Criar pedido (apenas v1)

**POST** `/account/v1/app/order/create`

Chamado antes do envio da ordem. Ap√≥s o pagamento, retorna o status da transa√ß√£o.

**Corpo da requisi√ß√£o**
```json
{
   "user_id": "string",          // ID do usu√°rio na plataforma
   "order_id": "string",         // ID do pedido na plataforma
   "side": "buy/sell",           // Compra ou venda
   "outcome": "yes/no",          // yes = aposta a favor, no = aposta contra
   "market_id": "string",        // ID do mercado
   "price": 0.000000,            // Pre√ßo
   "quantity": 0.000000,         // Quantidade
   "amount": 0.000000,           // Valor do pedido
   "fee": 0.000000,              // Taxa
   "timestamp": 0,
   "signature": "string"
}
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {
        "status": "success",  // success = sucesso, failed = falha
        "fail_reason": ""     // Motivo da falha, se existir
    }
}
```

### 6. Callback de execu√ß√£o (apenas v1)

**POST** `/account/v1/app/order/trade`

Acionado quando a ordem √© executada no Dapp. O comerciante deve responder confirmando o processamento.

**Corpo da requisi√ß√£o**
```json
{
   "order_id": "string",          // ID do pedido
   "trade_id": "string",          // ID da execu√ß√£o
   "side": "buy/sell",            // Lado da opera√ß√£o
   "outcome": "yes/no",           // Resultado apostado
   "price": 0.000000,             // Pre√ßo executado
   "quantity": 0.000000,          // Quantidade executada
   "amount": 0.000000,            // Valor executado
   "fee": 0.000000,               // Taxa
   "timestamp": 0,
   "signature": "string"
}
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {}
}
```

### 7. Callback de cancelamento (apenas v1)

**POST** `/account/v1/app/order/cancel`

Chamado quando a ordem √© cancelada no Dapp.

**Corpo da requisi√ß√£o**
```json
{
   "order_id": "string",
   "timestamp": 0,
   "signature": "string"
}
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {}
}
```

### 8. Callback de liquida√ß√£o (apenas v1)

**POST** `/account/v1/app/order/settlement`

Enviado ap√≥s a liquida√ß√£o do mercado para informar ganhos e perdas.

**Corpo da requisi√ß√£o**
```json
{
   "market_id": "string",
   "user_id": "string",
   "outcome": "yes/no",
   "quantity": 0.000000,
   "payout": 0.000000,
   "timestamp": 0,
   "signature": "string"
}
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {}
}
```

### 9. Consultar detalhes da ordem

**GET** `/account/v1/app/order/detail`

Permite verificar o status e os fills de uma ordem.

**Par√¢metro**
```
order_id=string
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": {
        "order_id": "string",
        "user_id": "string",
        "status": "string",
        "trades": [
           {
              "trade_id": "string",
              "price": 0.000000,
              "quantity": 0.000000,
              "amount": 0.000000,
              "fee": 0.000000,
              "created_at": "string"
           }
        ]
    }
}
```

### 10. Relat√≥rios do comerciante

**GET** `/account/v1/app/report`

Retorna dados agregados para um intervalo de datas.

**Par√¢metros**
```
start_date=string   // Formato yyyy-MM-dd
end_date=string     // Formato yyyy-MM-dd
```

**Resposta**
```json
{
    "code": 0,
    "message": "string",
    "data": [
       {
          "period_date": "string",       // Data do relat√≥rio
          "users": 0,                    // Usu√°rios ativos
          "total_deposit": 0.000000,     // Total depositado
          "total_withdraw": 0.000000,    // Total sacado
          "total_buy_volume": 0.000000,  // Volume comprado
          "total_sell_volume": 0.000000, // Volume vendido
          "currency": "string"           // Moeda
       }
    ]
}
```

## üîê Regras de assinatura

Todas as requisi√ß√µes que exigem assinatura utilizam `HMAC-SHA256`. Procedimento:

1. Converter o corpo da requisi√ß√£o (JSON em string) para UTF-8;
2. Calcular `HMAC-SHA256` usando `api_key` como chave;
3. Converter o resultado para string hexadecimal e usar como `signature`.

Exemplo em Python:
```python
import hmac
import hashlib

def sign(payload: str, api_key: str) -> str:
    return hmac.new(api_key.encode('utf-8'),
                    payload.encode('utf-8'),
                    hashlib.sha256).hexdigest()
```

## üìÑ Anexo

- Todas as respostas seguem o formato `code`, `message`, `data`;
- Requisi√ß√µes e respostas usam JSON e os valores num√©ricos mant√™m 6 casas decimais;
- Todos os hor√°rios s√£o em UTC;
- Recomenda-se registrar logs de todas as chamadas para facilitar auditoria e suporte.
